# 	:triangular_flag_on_post:	服务注册与发现

<p id="t"></p>

:arrow_down:[Eureka](#a1)

:arrow_down:[编写Eureka Server](#a2)

<b id="a1"></b>

### :arrow_up_small: Eureka

:arrow_up:[返回目录](#t)

Eureka是Netflix开源的服务发现组件，本身是一个基于REST的服务、它包含Server和Client两部分，Spring Cloud将它集成在项目Netflix中，从而实现微服务的注册与发现。

Eureka架构图如下：

![](https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=157413036,1729442593&fm=26&gp=0.jpg)

这是来自于Eureka官方的构架图，改图比较详细地描述了Eureka集群的工作原理，图中的组件也非常得多，概念也比较抽象，下面进行解释：

* Application Service 相当于本书的服务提供者。

* Application Client 相当于本书的服务消费者。

* Make Remote Call 可以理解成调用RESTful API的行为。

* us-east-1c/d等都是zone，他们都属于us-east-1这个region。（AWS概念）

可以看到Eureka包含两个组件，分别是是Server和Client，作用如下：

Eureka Server 提供服务发现能力，各个微服务启动时，会向Eureka Server注册自己的实例信息（IP，端口，服务名称），Server会储存这些信息。

Eureka Client是一个java客户端，用于简化与Eureka Server的交互。

微服务启动后，会周期性（默认30s）地向Eureka Server发送心跳以续约自己的“租期”。

如果Eureka Server在一定的时间内，没有接受到某个微服务的实例的心态后，Eureka Server会注销该实例（默认90s）

默认情况下，Eureka Server同时也是Eureka Client，多个Eureka Server实例相互之间通过赋复制的方式来实现注册表中的信息中的数据同步。

Eureka Client会缓存服务注册表中的信息，这样就无须每次请求都查询Eureka Server，从而降低了Eureka Server的压力，其次即使Eureka Server坏掉，任然可以使用缓存中的信息。

<b id="a2"></b>

### :arrow_up_small: 编写Eureka Server

:arrow_up:[返回目录](#t)

按照上一节的微电影项目来继续编写，新建一个项目,首先添加依赖：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>EurekaServer</groupId>
    <artifactId>EurekaServer</artifactId>
    <version>1.0-SNAPSHOT</version>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>1.5.9.RELEASE</version>
    </parent>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
      <!--EurekaServer服务依赖-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
            <version>1.4.0.RELEASE</version>
        </dependency>
    </dependencies>
</project>
```


编写启动类：

```java
@EnableEurekaServer
@SpringBootApplication
public class start {
    public static  void main(String[] args){
        SpringApplication.run(start.class,args);
    }
}
```
`@EnableEurekaServer`注解为开启EurekaServer


在配置文件中编写如下内容：

```java
server:
  port: 8761
eureka:
  client:
    fetch-registry: false
    register-with-eureka: false
    service-url:
      defaultZone: http://localhost:8761/eureka
```

* 其中fetch-registry表示是否从Eureka中获取注册信息，默认为true，因为这是一个单点的Eureka Server，不需要其他的Eureka Server的数据，所以设置为false

* register-with-eureka表示是否将自己注册到Eureka，默认为true，由于当前应用就是Server，所以也不需要。

* service-url 设置与service交互的地址，查询和注册服务都依赖这个地址，默认就是`http://localhost:8761/eureka`，多个地址间可以使用逗号分隔。这就就完成了一个Eureka Server。

运行项目访问`http://localhost:8761/`若看见如下图，说明配置成功！

![](https://github.com/Lumnca/Spring-Cloud/blob/master/img/a1.png)
